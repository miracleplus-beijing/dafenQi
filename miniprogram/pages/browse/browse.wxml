<!-- æ¼«æ¸¸é¡µé¢ - åŒæ¨¡å¼è®¾è®¡ -->
<view class="browse-page">

  <!-- Swiperæ¨¡å¼ -->
  <view wx:if="{{browseMode === 'swiper'}}" class="swiper-mode">
    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <view wx:if="{{index === currentIndex && isPlaying && audioLoading}}"
            class="podcast-loader">
        <image src="{{cdnImages.loadingIcon}}" class="loader-icon" alt="åŠ è½½ä¸­"></image>
    </view>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <view wx:if="{{!loading && podcastList.length > 0}}">
      <swiper class="browse-swiper"
              vertical="true"
              indicator-dots="{{false}}"
              autoplay="{{false}}"
              interval="999999"
              circular="false"
              current="{{currentIndex}}"
              duration="300"
              easing-function="easeInOutCubic"
              bindchange="handleSwiperChange"
              bindtouchstart="handleTouchStart"
              bindtouchmove="handleTouchMove">

        <swiper-item wx:for="{{podcastList}}" wx:key="id" class="browse-container">

          <!-- å†…å®¹å±•ç¤ºåŒºåŸŸ (60%) -->
          <view class="content-display">

            <!-- æ’­å®¢å°é¢ -->
            <view class="podcast-cover {{index === currentIndex && isPlaying ? 'playing' : ''}}">

              <view class="cover-image-container">
                <image wx:if="{{item.cover_url}}"
                       src="{{item.cover_url}}"
                       class="cover-image"
                       mode="aspectFill"
                       alt="{{item.title}}" />
                <view wx:else class="cover-placeholder">
                  <view class="cover-icon">ğŸµ</view>
                  <view class="cover-title">{{item.title}}</view>
                </view>

                <!-- æš‚åœé®ç½©æ•ˆæœ -->
                <view wx:if="{{index === currentIndex && !isPlaying}}" class="pause-overlay" >
                  <t-icon name="play" size="128rpx" class="pause-icon" />
                </view>
              </view>
            </view>

            <!-- æ ‡é¢˜åŒºåŸŸ -->
            <view class="title-section">
              <text class="main-title">{{item.title}}</text>
              <text class="sub-title">{{item.channel_name || 'è¾¾èŠ¬Qiè¯´'}}</text>
            </view>

            <!-- å†…å®¹æ‘˜è¦åŒºåŸŸ (æ›¿ä»£è®¤çŸ¥å¡ç‰‡) -->
            <view class="content-summary">
              <view class="summary-label">
                <text>å†…å®¹æ‘˜è¦</text>
                <t-icon name="bulb" size="32rpx" color="#ed8936" class="summary-icon" />
              </view>
              <text class="summary-text">{{item.description || 'è¿™æ˜¯ä¸€æœŸç²¾å½©çš„æ’­å®¢å†…å®¹ï¼ŒåŒ…å«äº†ä¸°å¯Œçš„çŸ¥è¯†ç‚¹å’Œæ·±åº¦æ€è€ƒã€‚'}}</text>
            </view>
          </view>

          <!-- æ’­æ”¾æ§åˆ¶åŒºåŸŸ (40%) -->
          <view class="playback-section">

            <!-- è¿›åº¦æ§åˆ¶ -->
            <view class="progress-section">
              <view class="time-info">
                <text class="current-time">{{currentTimeFormatted}}</text>
                <text class="total-time">{{totalTimeFormatted}}</text>
              </view>

              <view class="progress-container">
                <t-slider
                  value="{{currentProgress}}"
                  min="{{0}}"
                  max="{{100}}"
                  step="{{0.1}}"
                  theme="filled"
                  color="#ed8936"
                  track-color="#e2e8f0"
                  class="custom-slider"
                  bind:change="handleSliderChange"
                  bind:dragstart="handleSliderTouchStart"
                  bind:dragend="handleSliderTouchEnd"
                  show-value="{{false}}"
                />
              </view>
            </view>

            <!-- æ’­æ”¾æ§åˆ¶æŒ‰é’® -->
            <view class="playback-controls">
              <!-- æ’­æ”¾é€Ÿåº¦ -->
              <view class="control-btn" bindtap="handleSpeedChange">
                <text class="speed-display">{{playbackSpeed}}Ã—</text>
              </view>

              <!-- åé€€15ç§’ -->
              <view class="control-btn" bindtap="handleRewind">
                <image src="https://gxvfcafgnhzjiauukssj.supabase.co/storage/v1/object/public/static-images/icons/backward-15s.svg" class="control-icon"></image>
              </view>
              <!-- æ’­æ”¾/æš‚åœæŒ‰é’® -->
              <view class="play-btn" bindtap="handlePlayPause">

                <t-icon wx:if="{{ isPlaying }}" size="80rpx" name="pause" class="play-icon"  data-name="pause" bind:click="onIconTap" />
                <t-icon wx:else name="play" size="80rpx" class="play-icon"  data-name="play" bind:click="onIconTap" />

              </view>

              <!-- å‰è¿›30ç§’ -->
              <view class="control-btn" bindtap="handleFastForward">
                <image src="https://gxvfcafgnhzjiauukssj.supabase.co/storage/v1/object/public/static-images/icons/forward-30s.svg" class="control-icon" />
              </view>

              <!-- æ›´å¤šæ“ä½œ -->
              <view class="control-btn" bindtap="handleMore">
                <text class="more-icon">â‹¯</text>
              </view>
            </view>
          </view>

        </swiper-item>
      </swiper>
    </view>
  </view>

  <!-- ç€‘å¸ƒæµæ¨¡å¼ï¼ˆå°è£…ä¸ºå®¹å™¨ç»„ä»¶ï¼‰ -->
  <view wx:hidden="{{browseMode === 'waterfall'}}" class="waterfall-mode">
    <waterfall-container bind:play="handleWaterfallPlay" />
  </view>

  <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
  <view wx:if="{{loading}}" class="loading-indicator">
    <image src="{{cdnImages.loadingIcon}}" class="loading-icon"></image>
    <text>åŠ è½½ä¸­...</text>
  </view>

  <!-- å½“æ²¡æœ‰æ•°æ®æ—¶æ˜¾ç¤ºçš„å†…å®¹ -->
  <view wx:if="{{!loading && podcastList.length === 0}}" class="no-data-indicator">
    <text>æš‚æ— æ’­å®¢å†…å®¹</text>
  </view>

  <!-- è‡ªå®šä¹‰éŸ³é¢‘åŠ è½½æŒ‡ç¤ºå™¨ -->
  <view wx:if="{{audioLoadingVisible}}" class="custom-audio-loading">
    <view class="loading-overlay"></view>
    <view class="loading-content">
      <image src="{{cdnImages.loadingIcon}}" class="custom-loading-icon" alt="åŠ è½½ä¸­"></image>
      <text class="loading-text">{{audioLoadingText}}</text>
    </view>
  </view>

  <!-- æ›´å¤šæ“ä½œå¼¹çª— -->
  <view class="more-popup {{showMorePopup ? 'show' : ''}}" catchtouchmove="preventScroll">
    <view class="popup-mask" bindtap="handleCloseMorePopup"></view>
    <view class="popup-content more-popup-content">
      <view class="popup-header">
        <text class="popup-title">æ›´å¤šæ“ä½œ</text>
        <view class="popup-close" bindtap="handleCloseMorePopup">
          <t-icon name="close" size="48rpx" class="close-icon" />
        </view>
      </view>

      <!-- æ“ä½œé€‰é¡¹åˆ—è¡¨ -->
      <view class="more-actions-list">
        <!-- æ”¶è—æ“ä½œ -->
        <view class="more-action-item" bindtap="handleFavorite">
          <t-icon name="{{podcastList[currentIndex].isFavorited ? 'heart-filled' : 'heart'}}"
                  size="48rpx"
                  color="{{podcastList[currentIndex].isFavorited ? '#ed8936' : '#718096'}}"
                  class="action-icon" />
          <text class="action-text">{{podcastList[currentIndex].isFavorited ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—'}}</text>
        </view>

        <!-- è¯„è®ºæ“ä½œ -->
        <view class="more-action-item" bindtap="handleOpenComments">
          <t-icon name="chat" size="48rpx" color="#718096" class="action-icon" />
          <text class="action-text">è¯„è®º</text>
        </view>

        <!-- åˆ†äº«æ“ä½œ -->
        <view class="more-action-item" bindtap="handleShare">
          <t-icon name="share" size="48rpx" color="#718096" class="action-icon" />
          <text class="action-text">åˆ†äº«</text>
        </view>

        <!-- ä¸‹è½½æ“ä½œ -->
        <view class="more-action-item" bindtap="handleDownload">
          <t-icon name="download" size="48rpx" color="#718096" class="action-icon" />
          <text class="action-text">ä¸‹è½½</text>
        </view>
      </view>
    </view>
  </view>

  <!-- è¯„è®ºå¼¹çª—ç»„ä»¶ -->
  <comment-popup
    visible="{{showCommentPopup}}"
    comment-list="{{commentList}}"
    comment-input-text="{{commentInputText}}"
    replying-to-comment-id="{{replyingToCommentId}}"
    bind:close="handleCloseComments"
    bind:input="handleCommentInput"
    bind:send="handleSendComment"
    bind:reply="handleReplyComment"
    bind:like="handleLikeComment"
  />

  <!-- å…¨å±€è¿·ä½ æ’­æ”¾å™¨ -->
  <mini-player
    wx:if="{{browseMode !== 'swiper' && globalPlayer.isVisible}}"
    current-podcast="{{globalPlayer.currentPodcast}}"
    is-playing="{{globalPlayer.isPlaying}}"
    current-progress="{{globalPlayer.currentProgress}}"
    is-visible="{{globalPlayer.isVisible}}"
    safe-area-bottom="{{safeAreaBottom}}"
    bind:playpause="handleGlobalPlayerPlayPause"
    bind:expand="handleGlobalPlayerExpand"
    bind:close="handleGlobalPlayerClose" />

  <t-toast id="t-toast" />

</view>


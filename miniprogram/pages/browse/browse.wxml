<!-- Êº´Ê∏∏È°µÈù¢ -->
<view class="browse-page">
  <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü -->
  <view wx:if="{{!loading && podcastList.length > 0}}">
    <swiper class="browse-swiper" 
            vertical="true" 
            indicator-dots="false"
            indicator-color="rgba(0,0,0,0)"
            indicator-active-color="rgba(0,0,0,0)" 
            autoplay="{{false}}"
            interval="999999"
            circular="false"
            current="{{currentIndex}}"
            duration="300"
            easing-function="easeInOutCubic"
            bindchange="handleSwiperChange"
            bindtouchstart="handleTouchStart"
            bindtouchmove="handleTouchMove">
  <swiper-item wx:for="{{podcastList}}" wx:key="id" class="browse-container">
    <!-- Êí≠ÂÆ¢Â∞ÅÈù¢ -->
    <view class="podcast-cover">
      <image wx:if="{{item.cover_url}}" 
             src="{{item.cover_url}}" 
             class="cover-image" 
             mode="aspectFill" 
             alt="{{item.title}}" />
      <view wx:else class="cover-placeholder">
        <view class="cover-icon">üéµ</view>
        <view class="cover-title">{{item.title}}</view>
      </view>
      <!-- Âä†ËΩΩÊåáÁ§∫Âô® - Âè™Âú®Èü≥È¢ëÂä†ËΩΩÊó∂ÊòæÁ§∫ -->
      <view wx:if="{{index === currentIndex && isPlaying && audioLoading}}" 
            class="podcast-loader">
        <image src="{{cdnImages.loadingIcon}}" class="loader-icon" alt="Âä†ËΩΩ‰∏≠"></image>
      </view>
    </view>

    <!-- Êí≠ÂÆ¢Ê†áÈ¢ò - ÊîØÊåÅÊâãÂä®ÊãñÊãΩÂíåËá™Âä®ÊªöÂä® -->
    <view class="podcast-title-wrapper">
      <scroll-view
        scroll-x
        class="title-scroll-view {{autoScrollTitle ? 'auto-scrolling' : ''}}"
        scroll-left="{{titleScrollLeft}}"
        bindscroll="handleTitleScroll"
        bindtouchstart="handleTitleTouchStart"
        bindtouchend="handleTitleTouchEnd">
        <view class="title-content" style="width: {{titleWidth}}px;">
          <text class="title-text">{{item.title}}</text>
        </view>
      </scroll-view>
    </view>

    <!-- ËÆ§Áü•Âç°ÁâáÊªëÂä®Âå∫Âüü -->
    <view class="insight-cards-container">
      <swiper
        class="insight-swiper"
        indicator-dots="{{false}}"
        autoplay="{{autoPlayInsights}}"
        interval="5000"
        circular="{{insightList.length > 1}}"
        current="{{currentInsightIndex}}"
        bindchange="handleInsightChange"
        bindtouchstart="handleInsightTouchStart"
        bindtouchend="handleInsightTouchEnd">
        <swiper-item wx:for="{{insightList}}" wx:key="id" wx:for-item="insightItem" class="insight-card-wrapper">
          <view class="insight-card" bindtap="handleInsightCardClick" data-insight-id="{{insightItem.id}}">
            <view class="insight-header">
              <text class="insight-label">ËÆ§Áü•ÊèêÂèñ</text>
              <image src="https://gxvfcafgnhzjiauukssj.supabase.co/storage/v1/object/public/static-images/icons/insight.svg"
                     class="insight-icon" />
            </view>
            <text class="quote-text">{{insightItem.quote_text}}</text>
            <text class="quote-author">‚Äî‚Äî{{insightItem.quote_author}}</text>
          </view>
        </swiper-item>
      </swiper>
    </view>

    <!-- Êô∫ËÉΩÂàÜÂùóÁºìÂÜ≤ËøõÂ∫¶Êù° -->
    <view class="progress-container">
      <view class="progress-time-info">
        <text class="current-time">{{currentTimeFormatted}}</text>
        <!-- ÁΩëÁªúÁä∂ÊÄÅÊåáÁ§∫Âô® -->
        <view class="network-indicator {{networkStatus.isSlowNetwork ? 'slow' : 'fast'}}">
        </view>
        <text class="total-time">{{totalTimeFormatted}}</text>
      </view>
      
      <view class="progress-bar" bindtap="handleProgressClick">
        <!-- ËÉåÊôØËΩ®ÈÅì -->
        <view class="progress-track"></view>
        
        <!-- ÂàÜÂùóÁºìÂÜ≤ÊòæÁ§∫Â±Ç -->
        <view class="chunk-buffer-layer">
          <view wx:for="{{chunkDistribution}}" wx:key="index" 
                class="chunk-segment {{item.cached ? 'cached' : ''}} {{item.loading ? 'loading' : ''}}"
                style="left: {{item.left}}%; width: {{item.width}}%;">
          </view>
        </view>
        
        <!-- ‰º†ÁªüÁºìÂÜ≤ËøõÂ∫¶Êù°(‰Ωú‰∏∫Â§áÈÄâÊòæÁ§∫) -->
        <view class="progress-buffer {{chunkDistribution.length > 0 ? 'hidden' : ''}}" 
              style="width: {{bufferProgress}}%"></view>
        
        <!-- ÂΩìÂâçÊí≠ÊîæËøõÂ∫¶Êù° -->
        <view class="progress-fill" style="width: {{currentProgress}}%"></view>
        
        <!-- ÊãñÊãΩÊâãÊüÑ -->
        <view class="progress-thumb {{isDraggingThumb ? 'dragging' : ''}}" 
              style="left: {{currentProgress}}%" 
              catchtouchstart="handleThumbTouchStart"
              catchtouchmove="handleThumbMove"
              catchtouchend="handleThumbEnd">
        </view>
      </view>
    </view>

    <!-- ÊÇ¨ÊµÆËØÑËÆ∫Âç°ÁâáÔºàÊñ∞‰ΩçÁΩÆÔºöËøõÂ∫¶Êù°ÂíåÊéßÂà∂ÊåâÈíÆ‰πãÈó¥Ôºâ-->
    <view class="floating-playbar" bindtap="handleOpenComments">
      <image src="https://gxvfcafgnhzjiauukssj.supabase.co/storage/v1/object/public/static-images/icons/comment_quote.svg"
             class="playbar-quote-icon" />

      <image wx:if="{{floatingComment && floatingComment.user_avatar}}"
             src="{{floatingComment.user_avatar}}"
             class="playbar-avatar" />
      <image wx:else
             src="https://gxvfcafgnhzjiauukssj.supabase.co/storage/v1/object/public/static-images/icons/default-avatar.png"
             class="playbar-avatar" />

      <text class="playbar-comment-text">
        {{floatingComment ? floatingComment.content : 'ÊÉ†‰∫∫ËææÂ∑±ÔºåÂÆàÊ≠£Âá∫Â•á'}}
      </text>
    </view>

    <!-- Êí≠ÊîæÊéßÂà∂ -->
    <view class="playback-controls">
      <!-- Êí≠ÊîæÈÄüÂ∫¶ÊåâÈíÆ -->
      <view class="control-btn speed-btn" bindtap="handleSpeedChange">
        <text class="speed-text">{{playbackSpeed}}√ó</text>
      </view>

      <!-- ÂêéÈÄÄ15Áßí -->
      <view class="control-btn" bindtap="handleRewind">
        <image src="https://gxvfcafgnhzjiauukssj.supabase.co/storage/v1/object/public/static-images/icons/backward-15s.svg"
               class="icon" />
      </view>

      <!-- Êí≠Êîæ/ÊöÇÂÅúÊåâÈíÆ -->
      <view class="play-pause-btn" bindtap="handlePlayPause">
        <image src="{{isPlaying ? 'https://gxvfcafgnhzjiauukssj.supabase.co/storage/v1/object/public/static-images/icons/pause.svg' : 'https://gxvfcafgnhzjiauukssj.supabase.co/storage/v1/object/public/static-images/icons/play-large.svg'}}"
               class="play-pause-icon" />
      </view>

      <!-- ÂâçËøõ30Áßí -->
      <view class="control-btn" bindtap="handleFastForward">
        <image src="https://gxvfcafgnhzjiauukssj.supabase.co/storage/v1/object/public/static-images/icons/forward-30s.svg"
               class="icon" />
      </view>

      <!-- Êî∂ËóèÊåâÈíÆÔºàÈáëËâ≤ÊòüÊòüÔºâ-->
      <view class="control-btn favorite-btn" bindtap="handleFavorite">
        <image src="{{item.isFavorited ? 'https://gxvfcafgnhzjiauukssj.supabase.co/storage/v1/object/public/static-images/icons/collection_selected.svg' : 'https://gxvfcafgnhzjiauukssj.supabase.co/storage/v1/object/public/static-images/icons/collection_unselected.svg'}}"
               class="icon" />
      </view>
    </view>

    <!-- Êõ¥Â§öÊìç‰ΩúÊåâÈíÆ -->
    <view class="more-actions">
      <view class="more-btn" bindtap="handleMore">
        <text>‚ãØ</text>
      </view>
    </view>
    </swiper-item>
    </swiper>
  </view>

  <!-- Âä†ËΩΩÊåáÁ§∫Âô® -->
  <view wx:if="{{loading}}" class="loading-indicator">
    <image src="{{cdnImages.loadingIcon}}" class="loading-icon"></image>
    <text>Âä†ËΩΩ‰∏≠...</text>
  </view>

  <!-- ÂΩìÊ≤°ÊúâÊï∞ÊçÆÊó∂ÊòæÁ§∫ÁöÑÂÜÖÂÆπ -->
  <view wx:if="{{!loading && podcastList.length === 0}}" class="no-data-indicator">
    <text>ÊöÇÊó†Êí≠ÂÆ¢ÂÜÖÂÆπ</text>
  </view>

  <!-- Ëá™ÂÆö‰πâÈü≥È¢ëÂä†ËΩΩÊåáÁ§∫Âô® -->
  <view wx:if="{{audioLoadingVisible}}" class="custom-audio-loading">
    <view class="loading-overlay"></view>
    <view class="loading-content">
      <image src="{{cdnImages.loadingIcon}}" class="custom-loading-icon" alt="Âä†ËΩΩ‰∏≠"></image>
      <text class="loading-text">{{audioLoadingText}}</text>
    </view>
  </view>

  <!-- ËØÑËÆ∫ÂºπÁ™ó -->
  <view class="comment-popup {{showCommentPopup ? 'show' : ''}}" catchtouchmove="preventScroll">
    <view class="popup-mask" bindtap="handleCloseComments"></view>
    <view class="popup-content">
      <view class="popup-header">
        <text class="popup-title">ËØÑËÆ∫</text>
        <view class="popup-close" bindtap="handleCloseComments">
          <image src="https://gxvfcafgnhzjiauukssj.supabase.co/storage/v1/object/public/static-images/icons/close.svg"
                 class="close-icon" />
        </view>
      </view>

      <!-- ËØÑËÆ∫ÂàóË°® -->
      <scroll-view class="comment-list" scroll-y>
        <view wx:for="{{commentList}}" wx:key="id" class="comment-item">
          <image src="{{item.user_avatar}}" class="comment-avatar" />
          <view class="comment-content">
            <view class="comment-header">
              <text class="comment-user">{{item.user_nickname}}</text>
              <text class="comment-time">{{item.timestamp_formatted}}</text>
            </view>
            <text class="comment-text">{{item.content}}</text>
            <view class="comment-actions">
              <view class="comment-action-btn" bindtap="handleReplyComment" data-comment-id="{{item.id}}">
                <text>ÂõûÂ§ç</text>
              </view>
              <view class="comment-action-btn like-btn {{item.isLiked ? 'liked' : ''}}"
                    bindtap="handleLikeComment"
                    data-comment-id="{{item.id}}">
                <image src="https://gxvfcafgnhzjiauukssj.supabase.co/storage/v1/object/public/static-images/icons/like-small.svg"
                       class="like-icon" />
                <text>{{item.like_count > 0 ? item.like_count : ''}}</text>
              </view>
            </view>
          </view>
        </view>

        <!-- Á©∫ËØÑËÆ∫ÊèêÁ§∫ -->
        <view wx:if="{{commentList.length === 0}}" class="comment-empty">
          <text>ËøòÊ≤°ÊúâËØÑËÆ∫ÔºåÊù•Êä¢Ê≤ôÂèëÂêß~</text>
        </view>
      </scroll-view>

      <!-- ËØÑËÆ∫ËæìÂÖ•Ê°Ü -->
      <view class="comment-input-wrapper">
        <input
          class="comment-input"
          placeholder="{{replyingToCommentId ? 'ÂõûÂ§çËØÑËÆ∫...' : 'ÂèëË°®ËØÑËÆ∫...'}}"
          value="{{commentInputText}}"
          bindinput="handleCommentInput"
          confirm-type="send"
          bindconfirm="handleSendComment" />
        <view class="send-btn {{commentInputText.length > 0 ? 'active' : ''}}" bindtap="handleSendComment">
          <text>ÂèëÈÄÅ</text>
        </view>
      </view>
    </view>
  </view>
</view>
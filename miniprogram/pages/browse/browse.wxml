<!-- æ¼«æ¸¸é¡µé¢ -->
<view class="browse-page">
  <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
  <view wx:if="{{!loading && podcastList.length > 0}}">
    <swiper class="browse-swiper" 
            vertical="true" 
            indicator-dots="false"
            indicator-color="rgba(0,0,0,0)"
            indicator-active-color="rgba(0,0,0,0)" 
            autoplay="{{false}}"
            interval="999999"
            circular="false"
            current="{{currentIndex}}"
            duration="300"
            easing-function="easeInOutCubic"
            bindchange="handleSwiperChange"
            bindtouchstart="handleTouchStart"
            bindtouchmove="handleTouchMove">
  <swiper-item wx:for="{{podcastList}}" wx:key="id" class="browse-container">
    <!-- æ’­å®¢å°é¢ -->
    <view class="podcast-cover">
      <image wx:if="{{item.cover_url}}" 
             src="{{item.cover_url}}" 
             class="cover-image" 
             mode="aspectFill" 
             alt="{{item.title}}" />
      <view wx:else class="cover-placeholder">
        <view class="cover-icon">ğŸµ</view>
        <view class="cover-title">{{item.title}}</view>
      </view>
      <!-- åŠ è½½æŒ‡ç¤ºå™¨ - åªåœ¨éŸ³é¢‘åŠ è½½æ—¶æ˜¾ç¤º -->
      <view wx:if="{{index === currentIndex && isPlaying && audioLoading}}" 
            class="podcast-loader">
        <image src="{{cdnImages.loadingIcon}}" class="loader-icon" alt="åŠ è½½ä¸­"></image>
      </view>
    </view>

    <!-- æ’­å®¢æ ‡é¢˜ - æ”¯æŒæ‰‹åŠ¨æ‹–æ‹½å’Œè‡ªåŠ¨æ»šåŠ¨ -->
    <view class="podcast-title-wrapper">
      <scroll-view
        scroll-x
        class="title-scroll-view {{autoScrollTitle ? 'auto-scrolling' : ''}}"
        scroll-left="{{titleScrollLeft}}"
        bindscroll="handleTitleScroll"
        bindtouchstart="handleTitleTouchStart"
        bindtouchend="handleTitleTouchEnd">
        <view class="title-content" style="width: {{titleWidth}}px;">
          <text class="title-text">{{item.title}}</text>
        </view>
      </scroll-view>
    </view>

    <!-- è®¤çŸ¥å¡ç‰‡æ»‘åŠ¨åŒºåŸŸ -->
    <view class="insight-cards-container">
      <swiper
        class="insight-swiper"
        indicator-dots="{{false}}"
        autoplay="{{autoPlayInsights}}"
        interval="5000"
        circular="{{insightList.length > 1}}"
        current="{{currentInsightIndex}}"
        bindchange="handleInsightChange"
        bindtouchstart="handleInsightTouchStart"
        bindtouchend="handleInsightTouchEnd">
        <swiper-item wx:for="{{insightList}}" wx:key="id" wx:for-item="insightItem" class="insight-card-wrapper">
          <view class="insight-card" bindtap="handleInsightCardClick" data-insight-id="{{insightItem.id}}">
            <view class="insight-header">
              <text class="insight-label">è®¤çŸ¥æå–</text>
              <image src="https://gxvfcafgnhzjiauukssj.supabase.co/storage/v1/object/public/static-images/icons/insight.svg"
                     class="insight-icon" />
            </view>
            <text class="quote-text">{{insightItem.quote_text}}</text>
            <text class="quote-author">â€”â€”{{insightItem.quote_author}}</text>
          </view>
        </swiper-item>
      </swiper>
    </view>

    <!-- æ™ºèƒ½åˆ†å—ç¼“å†²è¿›åº¦æ¡ -->
    <view class="progress-container">
      <view class="progress-time-info">
        <text class="current-time">{{currentTimeFormatted}}</text>
        <!-- ç½‘ç»œçŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <view class="network-indicator {{networkStatus.isSlowNetwork ? 'slow' : 'fast'}}">
        </view>
        <text class="total-time">{{totalTimeFormatted}}</text>
      </view>
      
      <view class="progress-bar" bindtap="handleProgressClick">
        <!-- èƒŒæ™¯è½¨é“ -->
        <view class="progress-track"></view>
        
        <!-- åˆ†å—ç¼“å†²æ˜¾ç¤ºå±‚ -->
        <view class="chunk-buffer-layer">
          <view wx:for="{{chunkDistribution}}" wx:key="index" 
                class="chunk-segment {{item.cached ? 'cached' : ''}} {{item.loading ? 'loading' : ''}}"
                style="left: {{item.left}}%; width: {{item.width}}%;">
          </view>
        </view>
        
        <!-- ä¼ ç»Ÿç¼“å†²è¿›åº¦æ¡(ä½œä¸ºå¤‡é€‰æ˜¾ç¤º) -->
        <view class="progress-buffer {{chunkDistribution.length > 0 ? 'hidden' : ''}}" 
              style="width: {{bufferProgress}}%"></view>
        
        <!-- å½“å‰æ’­æ”¾è¿›åº¦æ¡ -->
        <view class="progress-fill" style="width: {{currentProgress}}%"></view>
        
        <!-- æ‹–æ‹½æ‰‹æŸ„ -->
        <view class="progress-thumb {{isDraggingThumb ? 'dragging' : ''}}" 
              style="left: {{currentProgress}}%" 
              catchtouchstart="handleThumbTouchStart"
              catchtouchmove="handleThumbMove"
              catchtouchend="handleThumbEnd">
        </view>
      </view>
    </view>

    <!-- æ‚¬æµ®è¯„è®ºå¡ç‰‡ï¼ˆæ–°ä½ç½®ï¼šè¿›åº¦æ¡å’Œæ§åˆ¶æŒ‰é’®ä¹‹é—´ï¼‰-->
    <view class="floating-playbar" bindtap="handleOpenComments">
      <image src="https://gxvfcafgnhzjiauukssj.supabase.co/storage/v1/object/public/static-images/icons/comment_quote.svg"
             class="playbar-quote-icon" />

      <image wx:if="{{floatingComment && floatingComment.user_avatar}}"
             src="{{floatingComment.user_avatar}}"
             class="playbar-avatar" />
      <image wx:else
             src="https://gxvfcafgnhzjiauukssj.supabase.co/storage/v1/object/public/static-images/icons/default-avatar.png"
             class="playbar-avatar" />

      <text class="playbar-comment-text">
        {{floatingComment ? floatingComment.content : 'æƒ äººè¾¾å·±ï¼Œå®ˆæ­£å‡ºå¥‡'}}
      </text>
    </view>

    <!-- æ’­æ”¾æ§åˆ¶ -->
    <view class="playback-controls">
      <!-- æ’­æ”¾é€Ÿåº¦æŒ‰é’® -->
      <view class="control-btn speed-btn" bindtap="handleSpeedChange">
        <text class="speed-text">{{playbackSpeed}}Ã—</text>
      </view>

      <!-- åé€€15ç§’ -->
      <view class="control-btn" bindtap="handleRewind">
        <image src="https://gxvfcafgnhzjiauukssj.supabase.co/storage/v1/object/public/static-images/icons/backward-15s.svg"
               class="icon" />
      </view>

      <!-- æ’­æ”¾/æš‚åœæŒ‰é’® -->
      <view class="play-pause-btn" bindtap="handlePlayPause">
        <image src="{{isPlaying ? 'https://gxvfcafgnhzjiauukssj.supabase.co/storage/v1/object/public/static-images/icons/pause.svg' : 'https://gxvfcafgnhzjiauukssj.supabase.co/storage/v1/object/public/static-images/icons/play-large.svg'}}"
               class="play-pause-icon" />
      </view>

      <!-- å‰è¿›30ç§’ -->
      <view class="control-btn" bindtap="handleFastForward">
        <image src="https://gxvfcafgnhzjiauukssj.supabase.co/storage/v1/object/public/static-images/icons/forward-30s.svg"
               class="icon" />
      </view>

      <!-- æ”¶è—æŒ‰é’®ï¼ˆé‡‘è‰²æ˜Ÿæ˜Ÿï¼‰-->
      <view class="control-btn favorite-btn" bindtap="handleFavorite">
        <image src="{{item.isFavorited ? 'https://gxvfcafgnhzjiauukssj.supabase.co/storage/v1/object/public/static-images/icons/collection_selected.svg' : 'https://gxvfcafgnhzjiauukssj.supabase.co/storage/v1/object/public/static-images/icons/collection_unselected.svg'}}"
               class="icon" />
      </view>
    </view>

    <!-- æ›´å¤šæ“ä½œæŒ‰é’® -->
    <view class="more-actions">
      <view class="more-btn" bindtap="handleMore">
        <text>â‹¯</text>
      </view>
    </view>
    </swiper-item>
    </swiper>
  </view>

  <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
  <view wx:if="{{loading}}" class="loading-indicator">
    <image src="{{cdnImages.loadingIcon}}" class="loading-icon"></image>
    <text>åŠ è½½ä¸­...</text>
  </view>

  <!-- å½“æ²¡æœ‰æ•°æ®æ—¶æ˜¾ç¤ºçš„å†…å®¹ -->
  <view wx:if="{{!loading && podcastList.length === 0}}" class="no-data-indicator">
    <text>æš‚æ— æ’­å®¢å†…å®¹</text>
  </view>

  <!-- è‡ªå®šä¹‰éŸ³é¢‘åŠ è½½æŒ‡ç¤ºå™¨ -->
  <view wx:if="{{audioLoadingVisible}}" class="custom-audio-loading">
    <view class="loading-overlay"></view>
    <view class="loading-content">
      <image src="{{cdnImages.loadingIcon}}" class="custom-loading-icon" alt="åŠ è½½ä¸­"></image>
      <text class="loading-text">{{audioLoadingText}}</text>
    </view>
  </view>

  <!-- è¯„è®ºå¼¹çª— -->
  <view class="comment-popup {{showCommentPopup ? 'show' : ''}}" catchtouchmove="preventScroll">
    <view class="popup-mask" bindtap="handleCloseComments"></view>
    <view class="popup-content">
      <view class="popup-header">
        <text class="popup-title">è¯„è®º</text>
        <view class="popup-close" bindtap="handleCloseComments">
          <image src="https://gxvfcafgnhzjiauukssj.supabase.co/storage/v1/object/public/static-images/icons/close.svg"
                 class="close-icon" />
        </view>
      </view>

      <!-- è¯„è®ºåˆ—è¡¨ -->
      <scroll-view class="comment-list" scroll-y>
        <view wx:for="{{commentList}}" wx:key="id" class="comment-item">
          <image src="{{item.user_avatar}}" class="comment-avatar" />
          <view class="comment-content">
            <view class="comment-header">
              <text class="comment-user">{{item.user_nickname}}</text>
              <text class="comment-time">{{item.timestamp_formatted}}</text>
            </view>
            <text class="comment-text">{{item.content}}</text>
            <view class="comment-actions">
              <view class="comment-action-btn" bindtap="handleReplyComment" data-comment-id="{{item.id}}">
                <text>å›å¤</text>
              </view>
              <view class="comment-action-btn like-btn {{item.isLiked ? 'liked' : ''}}"
                    bindtap="handleLikeComment"
                    data-comment-id="{{item.id}}">
                <image src="https://gxvfcafgnhzjiauukssj.supabase.co/storage/v1/object/public/static-images/icons/like-small.svg"
                       class="like-icon" />
                <text>{{item.like_count > 0 ? item.like_count : ''}}</text>
              </view>
            </view>
          </view>
        </view>

        <!-- ç©ºè¯„è®ºæç¤º -->
        <view wx:if="{{commentList.length === 0}}" class="comment-empty">
          <text>è¿˜æ²¡æœ‰è¯„è®ºï¼Œæ¥æŠ¢æ²™å‘å§~</text>
        </view>
      </scroll-view>

      <!-- è¯„è®ºè¾“å…¥æ¡† -->
      <view class="comment-input-wrapper">
        <input
          class="comment-input"
          placeholder="{{replyingToCommentId ? 'å›å¤è¯„è®º...' : 'å‘è¡¨è¯„è®º...'}}"
          value="{{commentInputText}}"
          bindinput="handleCommentInput"
          confirm-type="send"
          bindconfirm="handleSendComment" />
        <view class="send-btn {{commentInputText.length > 0 ? 'active' : ''}}" bindtap="handleSendComment">
          <text>å‘é€</text>
        </view>
      </view>
    </view>
  </view>
</view>
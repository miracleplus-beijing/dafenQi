<view class="browse-page-container">
    <!-- 引入 WXS 模块处理逻辑 (放在顶部) -->
    <wxs module="waveformUtils">
    module.exports.isPlayed = function(index, progress, total) {
        var current = Math.floor(progress / 100 * total);
        return index < current;
    }
    module.exports.isActive = function(index, progress, total) {
        var current = Math.floor(progress / 100 * total);
        return index === current;
    }
    </wxs>

    <!-- 漫游页面主体 -->
    <view class="browse-page">

        <!-- Swiper模式 -->
        <view wx:if="{{browseMode === 'swiper'}}" class="swiper-mode">
            <!-- 加载指示器 -->
            <view wx:if="{{index === currentIndex && isPlaying && audioLoading}}"
                  class="podcast-loader">
                <image src="{{cdnImages.loadingIcon}}" class="loader-icon" alt="加载中"></image>
            </view>

            <!-- 主要内容区域 -->
            <view wx:if="{{!loading && podcastList.length > 0}}" class="h-full">
                <swiper class="browse-swiper"
                        vertical="true"
                        indicator-dots="{{false}}"
                        autoplay="{{false}}"
                        interval="999999"
                        circular="false"
                        current="{{currentIndex}}"
                        duration="300"
                        easing-function="easeInOutCubic"
                        bindchange="handleSwiperChange"
                >

                    <swiper-item wx:for="{{podcastList}}" wx:key="id" class="browse-container">
                        
                        <!-- 1. 封面区域 (上部) -->
                        <view class="cover-section">
                            <!-- 光晕 -->
                            <view class="cover-glow {{index === currentIndex && isPlaying ? 'playing' : ''}}"></view>
                            
                            <!-- 圆形封面 -->
                            <view class="podcast-cover-circle {{index === currentIndex && isPlaying ? 'rotating' : ''}}"
                                  bindtap="handlePlayPause">
                                <image wx:if="{{item.cover_url}}"
                                       src="{{item.cover_url}}"
                                       class="cover-image-circle"
                                       mode="aspectFill"
                                       alt="{{item.title}}"/>
                                <view wx:else class="cover-placeholder-circle">
                                    <t-icon name="music" size="80rpx" color="#ffffff" />
                                </view>

                                <!-- 播放暂停覆盖 -->
                                <view class="play-overlay-circle {{index === currentIndex && isPlaying ? 'hidden' : ''}}">
                                    <t-icon name="play" size="60rpx" color="#ffffff" class="play-icon-overlay"/>
                                </view>
                            </view>
                        </view>

                        <!-- 2. 信息与控制面板 (Frosted Paper) -->
                        <view class="info-panel frosted-paper">
                            
                            <!-- 标题与摘要 -->
                            <view class="text-center-section">
                                <text class="main-title font-serif-display">{{item.title}}</text>
                                
                                <view class="meta-info">
                                    <view class="theme-dot"></view>
                                    <text class="channel-name">{{item.channel_name || '奇绩前沿信号'}}</text>
                                </view>
                                
                                <!-- 摘要点击进入阅读模式 -->
                                <view class="summary-link" bindtap="handleEnterReadingMode">
                                    <text class="summary-text">{{item.description || '这是一期精彩的播客内容，包含了丰富的知识点和深度思考...'}} (Read More)</text>
                                </view>
                            </view>

                            <!-- 播放控制与波形 -->
                            <view class="controls-section">
                                <!-- 进度时间 -->
                                <view class="time-info">
                                    <text class="current-time">{{item.playState.currentTimeFormatted}}</text>
                                    <text class="total-time">{{item.playState.totalTimeFormatted}}</text>
                                </view>

                                <!-- 重塑后的波形进度条 -->
                                <view class="waveform-progress-bar"
                                      bindtouchstart="handleWaveformTouchStart"
                                      bindtouchmove="handleWaveformTouchMove"
                                      bindtouchend="handleWaveformTouchEnd"
                                      data-podcast-id="{{item.id}}">
                                    
                                    <!-- 使用动态波形数据 -->
                                    <view class="waveform-strip">
                                        <view wx:for="{{waveformBars}}" wx:key="index" wx:for-item="bar"
                                              class="wave-bar {{waveformUtils.isPlayed(index, item.playState.progress, waveformBars.length) ? 'played' : ''}} {{waveformUtils.isActive(index, item.playState.progress, waveformBars.length) ? 'active' : ''}}"
                                              style="height: {{bar.height}}%; animation-delay: {{index * 0.1}}s">
                                        </view>
                                    </view>
                                </view>

                                <!-- 操作栏 -->
                                <view class="action-bar">
                                    <!-- 收藏/点赞 -->
                                    <view class="icon-btn" bindtap="handleFavorite">
                                        <t-icon name="{{item.isFavorited ? 'heart-filled' : 'heart'}}" size="48rpx" color="{{item.isFavorited ? '#ef4444' : '#9ca3af'}}" />
                                    </view>

                                    <!-- 评论 -->
                                    <view class="icon-btn" bindtap="handleOpenComments">
                                        <t-icon name="chat" size="48rpx" color="#9ca3af" />
                                    </view>
                                    
                                    <!-- 主播放按钮 -->
                                    <view class="main-play-btn shadow-glow" bindtap="handlePlayPause">
                                        <view class="play-btn-bg"></view>
                                        <t-icon name="{{isPlaying && index === currentIndex ? 'pause' : 'play'}}" size="56rpx" color="#ffffff" class="relative z-10" />
                                    </view>
                                    
                                    <!-- 分享 -->
                                    <button class="icon-btn share-btn" open-type="share">
                                        <t-icon name="share" size="48rpx" color="#9ca3af" />
                                    </button>

                                    <!-- 更多 -->
                                    <view class="icon-btn" bindtap="handleMore">
                                        <t-icon name="ellipsis" size="48rpx" color="#9ca3af" />
                                    </view>
                                </view>
                            </view>
                        </view>

                    </swiper-item>
                </swiper>
            </view>
        </view>

        <!-- 瀑布流模式（保持不变，略作背景适配） -->
        <view wx:if="{{browseMode === 'waterfall'}}" class="waterfall-mode">
            <waterfall-container bind:play="handleWaterfallPlay"/>
        </view>

        <!-- 加载指示器 -->
        <view wx:if="{{loading}}" class="loading-indicator">
            <image src="{{cdnImages.loadingIcon}}" class="loading-icon"></image>
            <text>加载中...</text>
        </view>

        <!-- 当没有数据时显示的内容 -->
        <view wx:if="{{!loading && podcastList.length === 0}}" class="no-data-indicator">
            <text>暂无播客内容</text>
        </view>

        <!-- 自定义音频加载指示器 -->
        <view wx:if="{{audioLoadingVisible}}" class="custom-audio-loading">
            <view class="loading-overlay"></view>
            <view class="loading-content frosted-glass">
                <image src="{{cdnImages.loadingIcon}}" class="custom-loading-icon" alt="加载中"></image>
                <text class="loading-text">{{audioLoadingText}}</text>
            </view>
        </view>

        <!-- 更多操作弹窗 -->
        <view class="more-popup {{showMorePopup ? 'show' : ''}}" catchtouchmove="preventScroll">
            <view class="popup-mask" bindtap="handleCloseMorePopup"></view>
            <view class="popup-content more-popup-content frosted-paper-popup">
                <view class="popup-header">
                    <text class="popup-title">更多操作</text>
                    <view class="popup-close" bindtap="handleCloseMorePopup">
                        <t-icon name="close" size="48rpx" class="close-icon"/>
                    </view>
                </view>

                <view class="more-actions-list">
                    <view class="more-action-item" bindtap="handleSpeedChange">
                        <t-icon name="time" size="48rpx" color="#718096" class="action-icon"/>
                        <text class="action-text">倍速 {{playbackSpeed}}×</text>
                    </view>
                    <view class="more-action-item" bindtap="handleDownload">
                        <t-icon name="download" size="48rpx" color="#718096" class="action-icon"/>
                        <text class="action-text">下载</text>
                    </view>
                </view>
            </view>
        </view>

        <!-- 评论弹窗组件 -->
        <comment-popup
                visible="{{showCommentPopup}}"
                comment-list="{{commentList}}"
                comment-input-text="{{commentInputText}}"
                replying-to-comment-id="{{replyingToCommentId}}"
                bind:close="handleCloseComments"
                bind:input="handleCommentInput"
                bind:send="handleSendComment"
                bind:reply="handleReplyComment"
                bind:like="handleLikeComment"
        />

    </view>

    <!-- 阅读模式遮罩层 (Paper Texture Overlay) -->
    <view wx:if="{{isReadingMode}}" class="reading-mode-overlay {{readingModeExpanded ? 'active' : ''}}">
        <!-- 顶部操作栏 -->
        <view class="reading-header" catchtouchmove="preventScroll">
            <view class="reading-close-btn" bindtap="handleExitReadingMode">
                <t-icon name="close" size="48rpx" color="#1a1a1a"/>
            </view>
            <text class="reading-mode-title font-serif-display">Reading Mode</text>
            <button class="reading-share-btn" open-type="share">
                <t-icon name="share" size="44rpx" color="#4a4a4a"/>
            </button>
        </view>

        <!-- 内容滚动区域 -->
        <scroll-view
                class="reading-content-scroll"
                scroll-y="true"
                enable-back-to-top="true"
                scroll-with-animation="true">
            <view class="reading-content-wrapper font-serif">
                <text class="reading-title font-serif-display">{{podcastList[currentIndex].title}}</text>
                
                <view class="reading-meta">
                    <view class="theme-dot-small"></view>
                    <text class="reading-channel">{{podcastList[currentIndex].channel_name}}</text>
                </view>

                <text class="reading-text">{{podcastList[currentIndex].description || '暂无内容摘要'}}</text>
                
                <view class="reading-footer-spacer"></view>
            </view>
        </scroll-view>

        <!-- 底部迷你播放条 (Frosted) -->
        <view class="reading-playback-bar frosted-paper-bottom" catchtouchmove="preventScroll">
            <image src="{{podcastList[currentIndex].cover_url}}" class="mini-cover-img" mode="aspectFill"></image>
            <view class="mini-info">
                <text class="mini-title">{{podcastList[currentIndex].title}}</text>
                <text class="mini-status">PLAYING</text>
            </view>
            <view class="mini-controls">
                <view class="mini-btn" bindtap="handleRewind">
                    <t-icon name="backward" size="40rpx" color="#4a4a4a"/>
                </view>
                <view class="mini-play-btn" bindtap="handlePlayPause">
                    <t-icon name="{{isPlaying ? 'pause' : 'play'}}" size="56rpx" color="#0884ff"/>
                </view>
                <view class="mini-btn" bindtap="handleFastForward">
                    <t-icon name="forward" size="40rpx" color="#4a4a4a"/>
                </view>
            </view>
        </view>
    </view>

    <!-- 全局迷你播放器 -->
    <mini-player
            wx:if="{{browseMode !== 'swiper' && globalPlayer.isVisible}}"
            current-podcast="{{globalPlayer.currentPodcast}}"
            is-playing="{{globalPlayer.isPlaying}}"
            current-progress="{{globalPlayer.currentProgress}}"
            is-visible="{{globalPlayer.isVisible}}"
            safe-area-bottom="{{safeAreaBottom}}"
            bind:playpause="handleGlobalPlayerPlayPause"
            bind:expand="handleGlobalPlayerExpand"
            bind:close="handleGlobalPlayerClose"/>

    <t-toast id="t-toast"/>

</view>

<!-- æ¼«æ¸¸é¡µé¢ - åŒæ¨¡å¼è®¾è®¡ -->
<view class="browse-page">

  <!-- Swiperæ¨¡å¼ -->
  <view wx:if="{{browseMode === 'swiper'}}" class="swiper-mode">
    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <view wx:if="{{index === currentIndex && isPlaying && audioLoading}}"
            class="podcast-loader">
        <image src="{{cdnImages.loadingIcon}}" class="loader-icon" alt="åŠ è½½ä¸­"></image>
    </view>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <view wx:if="{{!loading && podcastList.length > 0}}">
      <swiper class="browse-swiper"
              vertical="true"
              indicator-dots="{{false}}"
              autoplay="{{false}}"
              interval="999999"
              circular="false"
              current="{{currentIndex}}"
              duration="300"
              easing-function="easeInOutCubic"
              bindchange="handleSwiperChange"
              bindtouchstart="handleTouchStart"
              bindtouchmove="handleTouchMove">

        <swiper-item wx:for="{{podcastList}}" wx:key="id" class="browse-container">

          <!-- å†…å®¹å±•ç¤ºåŒºåŸŸ (60%) -->
          <view class="content-display">

            <!-- æ’­å®¢å°é¢ -->
            <view class="podcast-cover {{index === currentIndex && isPlaying ? 'playing' : ''}}">

              <view class="cover-image-container">
                <image wx:if="{{item.cover_url}}"
                       src="{{item.cover_url}}"
                       class="cover-image"
                       mode="aspectFill"
                       alt="{{item.title}}" />
                <view wx:else class="cover-placeholder">
                  <view class="cover-icon">ğŸµ</view>
                  <view class="cover-title">{{item.title}}</view>
                </view>

                <!-- æš‚åœé®ç½©æ•ˆæœ -->
                <view wx:if="{{index === currentIndex && !isPlaying}}" class="pause-overlay" >
                  <t-icon name="play" size="128rpx" class="pause-icon" />
                </view>
              </view>
            </view>

            <!-- æ ‡é¢˜åŒºåŸŸ -->
            <view class="title-section">
              <text class="main-title">{{item.title}}</text>
              <text class="sub-title">{{item.channel_name || 'è¾¾èŠ¬Qiè¯´'}}</text>
            </view>

            <!-- å†…å®¹æ‘˜è¦åŒºåŸŸ (æ›¿ä»£è®¤çŸ¥å¡ç‰‡) -->
            <view class="content-summary">
              <view class="summary-label">
                <text>å†…å®¹æ‘˜è¦</text>
                <t-icon name="bulb" size="32rpx" color="#ed8936" class="summary-icon" />
              </view>
              <text class="summary-text">{{item.description || 'è¿™æ˜¯ä¸€æœŸç²¾å½©çš„æ’­å®¢å†…å®¹ï¼ŒåŒ…å«äº†ä¸°å¯Œçš„çŸ¥è¯†ç‚¹å’Œæ·±åº¦æ€è€ƒã€‚'}}</text>
            </view>
          </view>

          <!-- æ’­æ”¾æ§åˆ¶åŒºåŸŸ (40%) -->
          <view class="playback-section">

            <!-- è¿›åº¦æ§åˆ¶ -->
            <view class="progress-section">
              <view class="time-info">
                <text class="current-time">{{currentTimeFormatted}}</text>
                <text class="total-time">{{totalTimeFormatted}}</text>
              </view>

              <view class="progress-container">
                <t-slider
                  value="{{currentProgress}}"
                  min="{{0}}"
                  max="{{100}}"
                  step="{{0.1}}"
                  theme="filled"
                  color="#ed8936"
                  track-color="#e2e8f0"
                  class="custom-slider"
                  bind:change="handleSliderChange"
                  bind:dragstart="handleSliderTouchStart"
                  bind:dragend="handleSliderTouchEnd"
                  show-value="{{false}}"
                />
              </view>
            </view>

            <!-- æ’­æ”¾æ§åˆ¶æŒ‰é’® -->
            <view class="playback-controls">
              <!-- æ’­æ”¾é€Ÿåº¦ -->
              <view class="control-btn" bindtap="handleSpeedChange">
                <text class="speed-display">{{playbackSpeed}}Ã—</text>
              </view>

              <!-- åé€€15ç§’ -->
              <view class="control-btn" bindtap="handleRewind">
                <image src="https://gxvfcafgnhzjiauukssj.supabase.co/storage/v1/object/public/static-images/icons/backward-15s.svg" class="control-icon"></image>
              </view>
              <!-- æ’­æ”¾/æš‚åœæŒ‰é’® -->
              <view class="play-btn" bindtap="handlePlayPause">

                <t-icon wx:if="{{ isPlaying }}" size="80rpx" name="pause" class="play-icon"  data-name="pause" bind:click="onIconTap" />
                <t-icon wx:else name="play" size="80rpx" class="play-icon"  data-name="play" bind:click="onIconTap" />

              </view>

              <!-- å‰è¿›30ç§’ -->
              <view class="control-btn" bindtap="handleFastForward">
                <image src="https://gxvfcafgnhzjiauukssj.supabase.co/storage/v1/object/public/static-images/icons/forward-30s.svg" class="control-icon" />
              </view>

              <!-- æ›´å¤šæ“ä½œ -->
              <view class="control-btn" bindtap="handleMore">
                <text class="more-icon">â‹¯</text>
              </view>
            </view>
          </view>

        </swiper-item>
      </swiper>
    </view>
  </view>

  <!-- ç€‘å¸ƒæµæ¨¡å¼ -->
  <view wx:if="{{browseMode === 'waterfall'}}" class="waterfall-mode">
    <!-- ç€‘å¸ƒæµå¤´éƒ¨ -->
    <waterfall-header
      search-value="{{searchKeyword}}"
      filter-options="{{filterOptions}}"
      bind:searchchange="handleWaterfallSearchChange"
      bind:searchsubmit="handleWaterfallSearchSubmit"
      bind:searchclear="handleWaterfallSearchClear"
      bind:filterchange="handleWaterfallFilterChange"
      bind:clearfilters="handleWaterfallClearFilters"
      />

    <!-- ç€‘å¸ƒæµå†…å®¹åŒºåŸŸ -->
    <scroll-view class="waterfall-content"
                 scroll-y
                 enable-back-to-top
                 refresher-enabled="{{true}}"
                 refresher-threshold="{{50}}"
                 refresher-default-style="white"
                 refresher-background="#f8f9fa"
                 refresher-triggered="{{waterfallRefreshing}}"
                 bindrefresherrefresh="handleWaterfallRefresh"
                 bindscrolltolower="handleWaterfallScrollToLower">

      <!-- åŒåˆ—ç½‘æ ¼å¸ƒå±€ -->
      <view class="waterfall-grid">
        <!-- å·¦åˆ— -->
        <view class="grid-column left-column">
          <waterfall-card
            wx:for="{{leftColumnList}}"
            wx:key="id"
            podcast="{{item}}"
            is-playing="{{globalPlayer.currentPodcast && globalPlayer.currentPodcast.id === item.id && globalPlayer.isPlaying}}" />
        </view>

        <!-- å³åˆ— -->
        <view class="grid-column right-column">
          <waterfall-card
            wx:for="{{rightColumnList}}"
            wx:key="id"
            podcast="{{item}}"
            is-playing="{{globalPlayer.currentPodcast && globalPlayer.currentPodcast.id === item.id && globalPlayer.isPlaying}}" />
        </view>
      </view>

      <!-- åŠ è½½æ›´å¤šæŒ‡ç¤ºå™¨ -->
      <view wx:if="{{waterfallLoading}}" class="waterfall-loading">
        <t-loading theme="circular" size="24px" />
        <text>åŠ è½½ä¸­...</text>
      </view>

      <!-- æ²¡æœ‰æ›´å¤šæ•°æ® -->
      <view wx:if="{{!hasMoreWaterfallData && waterfallList.length > 0}}" class="no-more-data">
        <text>æ²¡æœ‰æ›´å¤šå†…å®¹äº†</text>
      </view>

      <!-- ç©ºæ•°æ®æç¤º -->
      <view wx:if="{{waterfallList.length === 0 && !loading && !waterfallRefreshing}}" class="empty-state">
        <t-icon name="inbox" size="120rpx" color="#cbd5e0" />
        <text class="empty-text">æš‚æ— å†…å®¹</text>
        <text class="empty-hint">{{isSearchMode ? 'è¯•è¯•å…¶ä»–æœç´¢è¯' : 'ä¸‹æ‹‰åˆ·æ–°è¯•è¯•'}}</text>
      </view>
    </scroll-view>
  </view>

  <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
  <view wx:if="{{loading}}" class="loading-indicator">
    <image src="{{cdnImages.loadingIcon}}" class="loading-icon"></image>
    <text>åŠ è½½ä¸­...</text>
  </view>

  <!-- å½“æ²¡æœ‰æ•°æ®æ—¶æ˜¾ç¤ºçš„å†…å®¹ -->
  <view wx:if="{{!loading && podcastList.length === 0}}" class="no-data-indicator">
    <text>æš‚æ— æ’­å®¢å†…å®¹</text>
  </view>

  <!-- è‡ªå®šä¹‰éŸ³é¢‘åŠ è½½æŒ‡ç¤ºå™¨ -->
  <view wx:if="{{audioLoadingVisible}}" class="custom-audio-loading">
    <view class="loading-overlay"></view>
    <view class="loading-content">
      <image src="{{cdnImages.loadingIcon}}" class="custom-loading-icon" alt="åŠ è½½ä¸­"></image>
      <text class="loading-text">{{audioLoadingText}}</text>
    </view>
  </view>

  <!-- æ›´å¤šæ“ä½œå¼¹çª— -->
  <view class="more-popup {{showMorePopup ? 'show' : ''}}" catchtouchmove="preventScroll">
    <view class="popup-mask" bindtap="handleCloseMorePopup"></view>
    <view class="popup-content more-popup-content">
      <view class="popup-header">
        <text class="popup-title">æ›´å¤šæ“ä½œ</text>
        <view class="popup-close" bindtap="handleCloseMorePopup">
          <t-icon name="close" size="48rpx" class="close-icon" />
        </view>
      </view>

      <!-- æ“ä½œé€‰é¡¹åˆ—è¡¨ -->
      <view class="more-actions-list">
        <!-- æ”¶è—æ“ä½œ -->
        <view class="more-action-item" bindtap="handleFavorite">
          <t-icon name="{{podcastList[currentIndex].isFavorited ? 'heart-filled' : 'heart'}}"
                  size="48rpx"
                  color="{{podcastList[currentIndex].isFavorited ? '#ed8936' : '#718096'}}"
                  class="action-icon" />
          <text class="action-text">{{podcastList[currentIndex].isFavorited ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—'}}</text>
        </view>

        <!-- è¯„è®ºæ“ä½œ -->
        <view class="more-action-item" bindtap="handleOpenComments">
          <t-icon name="chat" size="48rpx" color="#718096" class="action-icon" />
          <text class="action-text">è¯„è®º</text>
        </view>

        <!-- åˆ†äº«æ“ä½œ -->
        <view class="more-action-item" bindtap="handleShare">
          <t-icon name="share" size="48rpx" color="#718096" class="action-icon" />
          <text class="action-text">åˆ†äº«</text>
        </view>

        <!-- ä¸‹è½½æ“ä½œ -->
        <view class="more-action-item" bindtap="handleDownload">
          <t-icon name="download" size="48rpx" color="#718096" class="action-icon" />
          <text class="action-text">ä¸‹è½½</text>
        </view>
      </view>
    </view>
  </view>

  <!-- è¯„è®ºå¼¹çª— -->
  <view class="comment-popup {{showCommentPopup ? 'show' : ''}}" catchtouchmove="preventScroll">
    <view class="popup-mask" bindtap="handleCloseComments"></view>
    <view class="popup-content">
      <view class="popup-header">
        <text class="popup-title">è¯„è®º</text>
        <view class="popup-close" bindtap="handleCloseComments">
          <t-icon name="close" size="48rpx" class="close-icon" />
        </view>
      </view>

      <!-- è¯„è®ºåˆ—è¡¨ -->
      <scroll-view class="comment-list" scroll-y>
        <view wx:for="{{commentList}}" wx:key="id" class="comment-item">
          <image src="{{item.user_avatar}}" class="comment-avatar" />
          <view class="comment-content">
            <view class="comment-header">
              <text class="comment-user">{{item.user_nickname}}</text>
              <text class="comment-time">{{item.timestamp_formatted}}</text>
            </view>
            <text class="comment-text">{{item.content}}</text>
            <view class="comment-actions">
              <view class="comment-action-btn" bindtap="handleReplyComment" data-comment-id="{{item.id}}">
                <text>å›å¤</text>
              </view>
              <view class="comment-action-btn like-btn {{item.isLiked ? 'liked' : ''}}"
                    bindtap="handleLikeComment"
                    data-comment-id="{{item.id}}">
                <t-icon name="{{item.isLiked ? 'heart-filled' : 'heart'}}"
                        size="32rpx"
                        color="{{item.isLiked ? '#ed8936' : '#718096'}}"
                        class="like-icon" />
                <text>{{item.like_count > 0 ? item.like_count : ''}}</text>
              </view>
            </view>
          </view>
        </view>

        <!-- ç©ºè¯„è®ºæç¤º -->
        <view wx:if="{{commentList.length === 0}}" class="comment-empty">
          <text>è¿˜æ²¡æœ‰è¯„è®ºï¼Œæ¥æŠ¢æ²™å‘å§~</text>
        </view>
      </scroll-view>

      <!-- è¯„è®ºè¾“å…¥æ¡† -->
      <view class="comment-input-wrapper">
        <input
          class="comment-input"
          placeholder="{{replyingToCommentId ? 'å›å¤è¯„è®º...' : 'å‘è¡¨è¯„è®º...'}}"
          value="{{commentInputText}}"
          bindinput="handleCommentInput"
          confirm-type="send"
          bindconfirm="handleSendComment" />
        <view class="send-btn {{commentInputText.length > 0 ? 'active' : ''}}" bindtap="handleSendComment">
          <text>å‘é€</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å…¨å±€è¿·ä½ æ’­æ”¾å™¨ -->
  <mini-player
    wx:if="{{browseMode === 'waterfall'}}"
    current-podcast="{{globalPlayer.currentPodcast}}"
    is-playing="{{globalPlayer.isPlaying}}"
    current-progress="{{globalPlayer.currentProgress}}"
    is-visible="{{globalPlayer.isVisible}}"
    safe-area-bottom="{{safeAreaBottom}}"
    bind:playpause="handleGlobalPlayerPlayPause"
    bind:expand="handleGlobalPlayerExpand"
    bind:close="handleGlobalPlayerClose" />

  <!-- å¿«é€Ÿé¢„è§ˆå¼¹çª— -->
  <quick-preview
    visible="{{showQuickPreview}}"
    podcast="{{quickPreviewPodcast}}"
    bind:trialplay="handleQuickPreviewTrialPlay"
    bind:trialpause="handleQuickPreviewTrialPause"
    bind:trialstop="handleQuickPreviewTrialStop"
    bind:favorite="handleQuickPreviewFavorite"
    bind:share="handleQuickPreviewShare"
    bind:addtoplaylist="handleQuickPreviewAddToPlaylist"
    bind:playfull="handleQuickPreviewPlayFull"
    bind:close="handleQuickPreviewClose" />

  <t-toast id="t-toast" />

</view>

